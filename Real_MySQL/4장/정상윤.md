# 4장 정리

## 4.1 MySQL 엔진 아키텍처

![image](https://user-images.githubusercontent.com/45227809/226368419-e8bd9496-2e91-49ac-8ceb-86fba84d98ea.png)


### MySQL 엔진

- 커넥션 핸들러, SQL Paser, Optimizer, 

- SQL 문장을 분석하고 최적화하는 역할을 수행

### 스토리지 엔진

- 실제 데이터를 디스크 스토리지에 저장, 디스크 스토리지로부터 데이터를 읽어오는 역할을 한다. 

### 핸들러 API 

- 핸들러 요청이란? 

    MySQL 엔진의 쿼리 실행기에서 데이터를 쓰거나 읽어야 할 때, 각 스토리지 엔진에 쓰기 또는 읽기를 요청하는 것.


### MySQL 스레딩 구조

- MySQL 서버는 프로세스 기반이 아니라 스레드 기반( https://velog.io/@raejoonee/%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EC%99%80-%EC%8A%A4%EB%A0%88%EB%93%9C%EC%9D%98-%EC%B0%A8%EC%9D%B4 )으로 작동한다.

- 스레드는 포그라운드/백그라운드 스레드로 구분 가능.

### 포그라운드 스레드 

- 최소한 MySQL 서버에 접속된 클라이언트 수만큼 존재하며, 주로 각 클라이언트 사용자가 요청하는 쿼리 문장을 처리.

- 커넥션이 종료되면, 스레드는 스레드 캐시로 되돌아간다.

- 이미 스레드 캐시에 일정 개수 이상의 대기중인 스레드가 있으면, 캐시에 넣지 않고 종료한다. 

- 최대 스레드 개수는 thread_cache_size 시스템 변수로 설정

- 데이터를 MySQL의 데이터 버퍼 혹은 캐시로부터 가져오며, 없다면 직접 디스크의 데이터나 인덱스 파일로부터 데이터를 읽어와서 처리.

### 백그라운드 스레드

- InnoDB의 경우 인서트 버퍼를 병합하는 스레드, 로그를 디스크로 기록하는 스레드, InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드, 데이터를 버퍼로 읽어오는 스레드, 잠금이나 데드락을 모니터링하는 스레드를 백그라운드로 처리.

- 로그 스레드와 쓰기 스레드가 가장 중요하다.

### 플러그인 스토리지 엔진 모델

- 스토리지 엔진 : 데이터의 읽기/쓰기 작업만 처리한다.

- 핸들러 : 어떤 기능을 호출하기 위해 사용하는 객체, 운전으로 비유하면 운전대와 같은 역할을 한다고 볼 수 있다.

- MySQL 엔진이 스토리지 엔진을 조정하기 위해 핸들러를 사용한다.

- MySQL 엔진이 각 스토리지 엔진에게 데이터를 읽어오거나 저장하도록 명령하기 위해서는 핸들러를 통해야 한다는 점만은 알아 둘 것.

- MySQL 엔진 영역과 스토리지 엔진 영역의 차이

### 쿼리 실행 구조

- MySQL 엔진 = 쿼리 파서 + 전처리기 + 옵티마이저 + 실행 엔진

- 쿼리 파서 : 사용자 요청으로 들어온 쿼리 문장을 토큰으로 분리해 트리 형태의 구조로 만들어 내는 작업, 여기서 토큰이란 MySQL이 인식할 수 있는 최소 단위
- 전처리기  : 쿼리 문장의 구조적 문제점 확인. 예) 테이블 이름, 칼럼 이름 존재 여부 등등
- 옵티마이저 : 저렴한 비용으로, 빠르게 처리하는 방법을 결정하는 단계. 어떻게 '옵티마이저가 더 나은 선택을 할 수 있게 유도하는가?'가 중요하다.
- 실행 엔진 : 중간 단계, 유통 기업 느낌. where 절에 포함된 조건들을 핸들러에게 처리 요청을 하고 반환된 값을 또 다시 다른 핸들러에게 전달하는 방식.
- 핸들러(스토리지 엔진) : 실행 엔진의 요청에 따라 데이터를 디스크로 저장하고 디스크로부터 읽어 오는 역할을 담당. MyISAM, InnoDB 등이 있다.
- 쿼리 캐시 : 실행 결과를 메모리에 캐시하고, 동일 SQL 쿼리가 실행되면 테이블을 읽지 않고 즉시 결과를 반환하기 떄문에 매우 빠른 성능의 장점이 있다. 하지만, 일반적 상황에서는 쿼리 캐시가 갖는 장점이 적기에 8.0 버전으로 올라오면서 관련 기능이 삭제.
- 스레드 풀 : 내부적으로 사용자의 요청을 처리하는 스레드 개수를 줄여서 동시에 처리하는 요청이 많다고 하더라도 MySQL 서버의 CPU가 제한된 개수의 스레드 처리에만 집중할 수 있게 해서 서버의 자원 소모를 줄이는 것이 

- 트랜잭션 지원 메타데이터 : 테이블의 구조 정보와 스토어드 프로그램 등의 정보를 메타 데이터라고 한다. MySQL 서버의 비정상적 종료에 대비하기 위해 정보를 자동으로 저장하는 것.

